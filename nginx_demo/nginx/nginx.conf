events {
    worker_connections 1024;
}

http {
    # --- 2. Upstream 负载均衡 ---
    # 定义一组后端服务，Nginx 会自动在这些服务间轮询
    upstream ml_backend {
        server api_1:8000; # 对应 docker-compose 中的服务名
        server api_2:8000;
    }

    server {
        # 监听 HTTP 端口
        listen 80;
        server_name your_domain.com; # 替换为你的真实域名或 localhost

        # --- 4. Certbot 验证路径 (HTTP-01 Challenge) ---
        # Certbot 需要访问这个路径来证明你拥有该域名
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # 强制重定向 HTTP 到 HTTPS (可选，建议开启)
        # location / {
        #     return 301 https://$host$request_uri;
        # }
        
        # --- 1. & 3. Nginx 作为反向代理服务 FastAPI ---
        # 暂时在 80 端口演示，获得证书后应只在 443 端口开启
        location / {
            proxy_pass http://ml_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }

    # --- 4. HTTPS 443 配置 (获得证书后取消注释) ---
    # server {
    #     listen 443 ssl;
    #     server_name your_domain.com;
    #
    #     ssl_certificate /etc/letsencrypt/live/your_domain.com/fullchain.pem;
    #     ssl_certificate_key /etc/letsencrypt/live/your_domain.com/privkey.pem;
    #
    #     location / {
    #         proxy_pass http://ml_backend;
    #         proxy_set_header Host $host;
    #         # ... 其他 headers
    #     }
    # }
}